<!DOCTYPE html><html lang="pt-br" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Detecção de objetos com haarcascade" /><meta property="og:locale" content="pt_br" /><meta name="description" content="Detecção de objetos usando o método Haar Cascade" /><meta property="og:description" content="Detecção de objetos usando o método Haar Cascade" /><link rel="canonical" href="/posts/cap5/" /><meta property="og:url" content="/posts/cap5/" /><meta property="og:site_name" content="Grupo OpenCV BR" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-04T08:25:34-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Detecção de objetos com haarcascade" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"dateModified":"2022-01-02T22:43:29-03:00","datePublished":"2020-12-04T08:25:34-03:00","description":"Detecção de objetos usando o método Haar Cascade","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/cap5/"},"url":"/posts/cap5/","@type":"BlogPosting","headline":"Detecção de objetos com haarcascade","@context":"https://schema.org"}</script><title>Detecção de objetos com haarcascade | Grupo OpenCV BR</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grupo OpenCV BR"><meta name="application-name" content="Grupo OpenCV BR"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grupo OpenCV BR</a></div><div class="site-subtitle font-italic">Espalhando a Palavra da Visão Computacional</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Grupo-OpenCV-BR" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Detecção de objetos com haarcascade</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Detecção de objetos com haarcascade</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Grupo OpenCV Brasil</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2020-12-04 08:25:34 -0300" data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 4, 2020, 8:25 AM -0300" >Dec 4, 2020</em> </span> <span> Updated <em class="timeago" date="2022-01-02 22:43:29 -0300 " data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 2, 2022, 10:43 PM -0300" >Jan 2</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1889 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h1 id="detecção-de-objetos-usando-o-método-haar-cascade">Detecção de objetos usando o método Haar Cascade</h1><p>Nesse capítulo você irá aprender uma maneira rápida e direta de como criar um classificador Haar Cascade. Além disso, no final do capítulo será disponibilizado um código para detecção de objetos com o classificador criado, que com pequenas alterações, pode se adequar a qualquer situação.</p><p>Nesse contexto, o método Haar Cascade, é um método de detecção de objetos proposto por Paul Viola e Michael Jones. É uma abordagem baseada em Machine Learning, em que uma função cascade é treinada com muitas imagens positivas e negativas. Logo, é usado para detectar objetos em outras imagens.</p><h2 id="preparando-o-ambiente">Preparando o ambiente<a href="#preparando-o-ambiente" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Para esse projeto é necessário que você tenha instalado em sua máquina apenas 3 itens.</p><p>1 - Editor de textos de sua preferência, eu particularmente uso o Visual Studio Code.</p><p>2 - Alguma versão Python de sua preferência, eu particularmente uso a 3.8.5.</p><p>3 - Biblioteca OpenCV .</p><p>Aqui não irei explicar como você pode fazer o download e instalação desses itens, pois na internet existem diversos tutorias detalhados de como fazer isso.</p><h2 id="passos">Passos<a href="#passos" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>A criação de um classficador usando o HaarCascade pode ser descrita em um conjunto de 5 passos.</p><p>1 - Escolher o objeto.</p><p>2 - Selecionar imagens negativas.</p><p>3 - Selecionar imagens positivas.</p><p>4 - Gerar o vetor de positivas.</p><p>5 - Treinar o classificador.</p><h3 id="1---escolher-o-objeto">1 - Escolher o objeto.<a href="#1---escolher-o-objeto" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>O primeiro passo é escolher o objeto que será identificado, para isso você deverá pensar nos seguintes aspectos:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>* Serão objetos rígidos como uma logo (nike) ou com variações (cadeira,copo)?

* Objetos rigidos são mais eficientes e mais rápidos.

* Ao treinar muitas variações pode ser que o classificador fique fraco, portanto, fique atento a isso.

* Objetos que a cor é fundamental não são recomendados, pois as imagens serão passadas para a escala de cinza.
</pre></table></code></div></div><p>Para esse projeto, escolhi o objeto faca para ser detectado.</p><h3 id="2---selecionar-imagens-negativas">2 - Selecionar imagens negativas.<a href="#2---selecionar-imagens-negativas" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>Para selecionar as imagens negativas, você deve ficar atento aos seguintes aspectos:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>* Podem ser qualquer coisa, menos o objeto.

* Devem ser maiores que as positivas, pois a openCV vai colocar as imagens positivas dentro das negativas.

* Se possível usar fotos de prováveis fundos onde o objeto é encontrado.

    *Ex: Objeto = carro
     Usar imagens de asfalto e ruas vazias.
</pre></table></code></div></div><p>Logo, você deve ficar atento as imagens escolhidas, pois como dito elas podem ser qualquer coisa, exceto o objeto escolhido, como escolhemos facas como objeto de detecção devemos, iremos precisar de imagens que não tenham facas.</p><p>Quantas imagens negativas? É relativo, para esse projeto eu conto com 3000 imagens negativas, com diversas variações de fundo. Entretanto, isso vai depender dos resultados obtidos no treinamento, pode ser que eu precise de mais imagens ou não, isso será explicado mais a frente com mais detalhes.</p><p>Exemplos de imagens negativas:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/86.jpg" width="100" height="100" data-proofer-ignore/></div><p align="center"> <b>Figura 1</b></p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/2833.jpg" width="100" height="100" data-proofer-ignore/></div><p align="center"> <b>Figura 2</b></p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/43.jpg" width="100" height="100" data-proofer-ignore/></div><p align="center"> <b>Figura 3</b></p><p>OBS: Todas essas imagens tem dimensões 100x100, essa informação será importante para futuras explicações.</p><p>Aqui é importante mencionar que você deve criar uma pasta (ex: projeto) onde estará outra pasta com as imagens negativas, na pasta projeto também deve estar as imagens positivas.</p><p>Exemplo:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 200'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/1.jpg" width="1000" height="200" data-proofer-ignore/></div><p align="center"> <b>Pasta</b></p><p>Na pasta das imagens negativas você deve colocar esse arquivo:</p><p>https://github.com/luis131313/cookbook/blob/master/imagens/cap2/criar_lista.bat</p><p>E deve executá-lo ao final da escolha das imagens negativas, pois ele vai gerar uma lista com as imagens negativas.</p><h3 id="3--selecionar-imagens-positivas">3 -Selecionar imagens positivas.<a href="#3--selecionar-imagens-positivas" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>Para selecionar as imagens positivas, você deve ficar atento aos seguintes aspectos:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>* Apenas o objeto.

* Quantas imagens?

    * Depende da: Qualidade da imagem, tipo do objeto, poder computacional disponível.

* As imagens devem ter o mesmo tamanho e a proporção precisa ser a mesma, caso contrário a openCV faz isso 
automaticamente e gera problemas de distorção do objeto.

    * Ex: Uma imagem 100x50, passada pra 25x25, vai ter o objeto descaracterizado.

* Imagens grandes podem gerar problemas, fazendo o treinamento durar até meses.

* Sempre que possível usar imagens com fundo branco.
</pre></table></code></div></div><p>Como dito no primeiro passo, você deve tomar cuidado com as variações do objeto, caso você queira realizar a detecção de um objeto em diferentes ângulos é sugerido que você faça diferentes classificadores. Para exemplificar isso, cito o classificador haarcascade frontal face, que realiza a detecção frontal da face (esse classificador inclusive é de fácil acesso, até a openCV disponibiliza ele pra você) e caso você queira a detecção lateral da face, você deve usar outro classificador, esses cuidados devem ser tomados para que você tenha um bom classificador.</p><p>Em relação a quantidade, alguns estudos sugerem que um bom classificador deve ter no mínimo 5000 mil imagens como entrada para o treinamento.</p><p>Exemplos de imagens positivas que irei usar para o treinamento do classificador:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/faca_9.png" width="100" height="50" data-proofer-ignore/></div><p align="center"> <b>Figura 1</b></p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/faca_4.png" width="100" height="50" data-proofer-ignore/></div><p align="center"> <b>Figura 2</b></p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/faca_10.png" width="100" height="50" data-proofer-ignore/></div><p align="center"> <b>Figura 3</b></p><p>OBS: Todas essas imagens tem dimensões 100x50, essa informação será importante para explicações futuras.</p><p>Aqui temos o pulo do gato, é possível criar mais imagens positivas a partir das imagens que você já tem, para isso baixe esse arquivo:</p><p>https://github.com/luis131313/cookbook/blob/master/imagens/cap2/opencv_createsamples.exe</p><p>Coloque ele junto com as imagens positivas, depois basta abrir o CMD, entrar na pasta onde estão suas imagens positivas e digitar esse comando:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>opencv_createsamples -img faca_1.png -bg negativas/bg.txt -info positivas/positivas.lst -maxxangle 0.5 -maxyangle 0.5 -maxzangle 0.5 -num 300 -bgcolor 255 -bgthresh 10
</pre></table></code></div></div><p>Parâmetros:</p><p>-img = Nome da imagem base.</p><p>-bg = Nome da pasta / nome do arquivo .txt com as informações das imagens negativas.</p><p>-info = Nome da pasta / Nome do arquivo .lst (sempre altere esse parâmetro quando usar uma nova imagem (Ex: positivas2/positivas2.lst, positivas3/positivas3.lst)).</p><p>-maxangle (x,y,z) = Variação de rotação que a imagem terá.</p><p>-num = Número de imagens que serão criadas.</p><p>-bgtresh = parâmetro que permite a retirada do fundo da imagem, deixando apenas o objeto de interesse (aqui se justifica o fundo branco). Esse parâmetro deve ser analisado com cuidado, pois:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/8.jpg" width="100" height="50" data-proofer-ignore/></div><p align="center"> <b>bgtresh 10</b></p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/0001_0010_0010_0060_0060.jpg" width="100" height="50" data-proofer-ignore/></div><p align="center"> <b>bgtresh 100</b></p><p>Como resultado você terá a quantidade de imagens mencionada em uma pasta de acordo com o nome que você escolheu e um arquivo .lst que terá informações sobre essas imagens, esse arquivo é de extrema importância e é a partir dele que iremos criar o vetor de imagens.</p><p>Nesse caso, usei 10 imagens e criei um total de 3000 imagens a partir desse comando, logo, você terá as pastas positivas1, positivas2 e etc…</p><p>Ex:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/2.jpg" width="200" height="200" data-proofer-ignore/></div><p align="center"> <b>Pasta</b></p><h2 id="4---gerar-o-vetor-de-positivas">4 - Gerar o vetor de positivas.<a href="#4---gerar-o-vetor-de-positivas" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Aqui você deverá criar um vetor para cada pasta com as imagens positiva (positivas1, positivas2, etc…) e depois juntar esses vetores em apenas um vetor. Para isso, digite esse comando no CMD:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>opencv_createsamples -info positivas1/positivas1.lst -num 2000 -w 50 -h 25 -vec vetor1.vec
</pre></table></code></div></div><p>Parâmetros:</p><p>-info = Nome da pasta que contém as imagens / arquivo .lst (Como criamos 3000 imagens a partir de 10 imagens, temos 10 pastas com 300 imagens cada, logo, teremos que repetir esse comando 10 vezes, alterando o nome da pasta e do arquivo .lst, para positivas2 / positivas2.lst, etc…).</p><ul><li><p>w e -h = são as dimensões, como nossas imagens eram 100 x 50, eu reduzi para 50 x 25, para reduzir o tamanho do arquivo, até porque para treinar o classificador com as imagens em 100 x 50 eu deveria ter um super computador.</p><li><p>vec = Nome do vetor (Aqui você também tem que alterar, colocando vetor1, vetor2, etc…).</p></ul><p>Após isso, devemos unir todos esses vetores em apenas um, para isso crie uma pasta chamada “vec” e coloque todos os vetores nela.</p><p>Depois baixe esse arquivo:</p><p>https://github.com/luis131313/cookbook/blob/master/imagens/cap2/mergevec.py</p><p>e coloque ele na pasta do seu projeto.</p><p>após isso, digite no CMD:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python mergevec.py -v vec/ -o vetor_final.vec
</pre></table></code></div></div><p>Após a conclusão você terá um arquivo chamado vetor_final.vec, que é o vetor que iremos utilizar.</p><p>Nesse momento a pasta do seu projeto estará assim:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 807 323'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/projeto.png" width="807" height="323" data-proofer-ignore/></div><p align="center"> <b>Pasta “Projeto”</b></p><h2 id="5---treinar-o-classificador">5 - Treinar o classificador<a href="#5---treinar-o-classificador" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Para o passo final, você deve primeiramente baixar esses arquivos:</p><p>https://github.com/luis131313/cookbook/blob/master/imagens/cap2/opencv_traincascade.exe</p><p>https://mega.nz/file/09YnVKQb#LdE1iz05i9OeoMqoZtuC3lVn4teeA7gqozVS-N1hG2U</p><p>Após isso, você deve abrir a pasta negativas e colocar esses dois arquivos e o vetor final nela, e criar uma pasta chamada “classificador”.</p><p>Dessa maneira:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 807 323'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/negativas3.png" width="807" height="323" data-proofer-ignore/></div><p align="center"> <b>Pasta “classificador”</b></p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 807 323'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/negativas2.png" width="807" height="323" data-proofer-ignore/></div><p align="center"> <b>Arquivos</b></p><p>Após isso, abra o CMD na pasta negativas e digite o seguinte comando:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>opencv_traincascade -data classificador -vec vetor_final.vec -bg bg.txt -numPos 2400 -numNeg 1200 -numStages 15 -w 30 -h 15 -precalcBufSize 1024 -precalcIdxBufSize 1024
</pre></table></code></div></div><p>Parâmetros</p><p>-data = Nome da pasta que os arquivos de treinamento serão armazenados.</p><p>-vec = Nome do vetor.</p><p>-bg = informações das imagens negativas.</p><p>-numPos = Número de imagens positivas.</p><p>-numNeg = Número de imagens negativas.</p><p>-numStages = Número de estágios.</p><p>-w e -h = dimensões das imagens.</p><p>-precalcBufSize e -precalcIdxBufSize = memória utilizada para o treinamento.</p><p>Após o treinamento, na pasta classificador você terá esses arquivos:</p><div class="image-container" style="display: flex; justify-content: center;"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 798 217'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/cascade.png" width="798" height="217" data-proofer-ignore/></div><p align="center"> <b>Arquivos</b></p><p>O arquivo cascade.xml é o nosso classificador.</p><p>O arquivo params.xml são os parâmetros usados no treinamento.</p><p>E os outros arquivos, são os resultados de cada estágio do treinamento.</p><p>Sobre o uso dos parâmetros:</p><ul><li><p>É indicado que você use metade do número de imagens positivas para as negativas no primeiro treinamento.</p><li><p>Alguns estudos sugerem que um bom classificador deve ter no mínimo 5000 imagens positivas.</p><li><p>Após o primeiro treinamento, se você notar que está tendo muitos falsos positivos, aumente o número de imagens negativas, se notar que não está realizando a detecção, aumente o número de imagens positivas, faça novos treinamentos até ter bons resultados.</p><li><p>Para melhorar os resultados você também pode aumentar o número de estágios.</p><li><p>Não se esqueça que a soma dos parâmetros -precalcBufSize e -precalcIdxBufSize não pode ser maior que a memória disponível.</p><li><p>Quanto mais imagens negativas, positivas, estágios de treinamento e dimensão das imagens, mais o treinamento vai demorar, podendo fazer o treinamento durar até meses.</p></ul><h2 id="código-para-detecção">Código para detecção<a href="#código-para-detecção" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Agora irei apresentar um código que irá realizar a detecção de facas.</p><p>Para isso baixe esse classificador que eu criei, ele ainda não está pronto, logo não irá apresentar resultados excelentes.</p><p>https://github.com/luis131313/cookbook/blob/master/imagens/cap2/cascade_facas.xml</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="c1">#variável que armazena a imagem
</span>
<span class="n">imagem1</span> <span class="o">=</span> <span class="s">'teste1.png'</span>

<span class="c1">#variável que armazena o arquivo xml
</span>
<span class="n">cascade_path1</span> <span class="o">=</span> <span class="s">'cascade_facas.xml'</span> 

<span class="c1">#cria o classificador
</span>
<span class="n">clf1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">CascadeClassifier</span><span class="p">(</span><span class="n">cascade_path1</span><span class="p">)</span>

<span class="c1">#lê a imagem
</span>
<span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imagem1</span><span class="p">)</span>

<span class="c1">#converte para cinza
</span>
<span class="n">gray1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="c1">#Função da detecção
</span>
<span class="n">deteccoes1</span> <span class="o">=</span> <span class="n">clf1</span><span class="p">.</span><span class="n">detectMultiScale</span><span class="p">(</span><span class="n">gray1</span><span class="p">,</span> <span class="n">scaleFactor</span><span class="o">=</span><span class="mf">1.01</span><span class="p">,</span> <span class="n">minNeighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">minSize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="c1">#desenha o retângulo com as coordenadas obtidas
</span>
<span class="k">for</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">deteccoes1</span><span class="p">:</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1">#para visualizar a imagem
</span>
<span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'Classificador 1'</span><span class="p">,</span> <span class="n">img1</span><span class="p">)</span>

<span class="c1">#mantém a janela aberta até que eu digite uma tecla
</span>
<span class="n">cv2</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#destrói a janela
</span>
<span class="n">cv2</span><span class="p">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

</pre></table></code></div></div><p>Ao executar o código com um exemplo, teremos essa detecção:</p><div align="center"><p align="center"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1193 667'%3E%3C/svg%3E" data-src="/assets/img/imagens/cap2/resultado.png" width="1193" height="667" data-proofer-ignore/></p><p> <b> Imagem retirada do Google</b></p></div><p>Podemos notar alguns falsos positivos, o que indica que seria interessante realizar um novo treinamento com mais imagens negativas.</p><h2 id="considerações-finais">Considerações finais<a href="#considerações-finais" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Vários dos arquivos apresentados foram cedidos pela www.iaexpert.academy, agradeço imensamente pela generosidade.</p><p>Fiz esse tutorial com muito carinho e espero que seja útil para você, a intenção aqui foi realizar um pequeno projeto usando o método HaarCascade, ainda existe muito há aprender sobre esse método, mas a minha intenção é apenas introduzir esse assunto.</p><p>Desejo bons estudos e bons trabalhos.</p><p>Atenciosamente,</p><p>Luis Fernando Santos Ferreira, Aluno do curso de Ciência da Computação na Universidade Federal de Lavras.</p><p>Linkedin: https://www.linkedin.com/in/luis-ferreira-3b02131a8/</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/haarcascade/'>haarcascade</a>, <a href='/categories/detec%C3%A7%C3%A3o/'>detecção</a>, <a href='/categories/classificador/'>classificador</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Detecção de objetos com haarcascade - Grupo OpenCV BR&url=/posts/cap5/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Detecção de objetos com haarcascade - Grupo OpenCV BR&u=/posts/cap5/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Detecção de objetos com haarcascade - Grupo OpenCV BR&url=/posts/cap5/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/VCPKG_como_usar/">VCPKG, como usar ?</a><li><a href="/posts/capturando_dados_kinect/">Aquisição de dados usando o Sensor Kinect do Xbox 360</a><li><a href="/posts/como_contribuir/">Como contribuir neste Blog</a><li><a href="/posts/cap1/">Detecção de Bordas</a><li><a href="/posts/cap2/">Processamento Morfológico de Imagens</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/getting-started/">getting started</a> <a class="post-tag" href="/tags/kinect-libfreenec-c/">kinect libfreenec c++</a> <a class="post-tag" href="/tags/vcpkg-windows-c/">vcpkg windows c++</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/VCPKG_como_usar/"><div class="card-body"> <em class="timeago small" date="2022-03-05 21:18:34 -0300" >Mar 5</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>VCPKG, como usar ?</h3><div class="text-muted small"><p> Antes de tudo, o que é VCPKG ? Te respondo , é um gerenciador de pacotes tal como Pip (Python) ou Maven (Java) para o C++, que carecia de um gerenciador tão poderoso como esse. Criado pela Micros...</p></div></div></a></div><div class="card"> <a href="/posts/capturando_dados_kinect/"><div class="card-body"> <em class="timeago small" date="2022-02-03 21:14:34 -0300" >Feb 3</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Aquisição de dados usando o Sensor Kinect do Xbox 360</h3><div class="text-muted small"><p> Neste artigo trago um rápido tutorial para que você possa começar a utilizar o sensor kinect do xbox 360 (Kinect v1) para adquirir imagens RGB e mapa de profundidade. Usaremos a libfreenect (OpenKi...</p></div></div></a></div><div class="card"> <a href="/posts/como_contribuir/"><div class="card-body"> <em class="timeago small" date="2022-01-23 16:42:34 -0300" >Jan 23</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Como contribuir neste Blog</h3><div class="text-muted small"><p> Aprenda como enviar o seu tutorial em forma de artigo para o Blog oficial do Grupo OpenCV Brasil (apelidado carinhosamente de OpenCVismo Brasil). 1. Fork o repositório do Blog Acesse o repositóri...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cap3/" class="btn btn-outline-primary" prompt="Older"><p>Filtro de densidade usando Machine Learning e Clusterização</p></a> <a href="/posts/como_contribuir/" class="btn btn-outline-primary" prompt="Newer"><p>Como contribuir neste Blog</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">Grupo OpenCV Brasil</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/getting-started/">getting started</a> <a class="post-tag" href="/tags/kinect-libfreenec-c/">kinect libfreenec c++</a> <a class="post-tag" href="/tags/vcpkg-windows-c/">vcpkg windows c++</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
